<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Celengan Digital Saya (Final Lengkap)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Reset CSS Dasar & Tema Gelap */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Nunito Sans', sans-serif;
            background-color: #1a1a1a; /* Latar belakang gelap utama */
            color: #e0e0e0;       /* Teks terang utama */
            line-height: 1.6;
            padding-top: 80px; /* Ruang untuk nav fixed jika ada */
            padding-bottom: 20px;
        }

        .page-container { /* Wrapper untuk konten halaman agar bisa di-center jika pendek */
            display: flex;
            flex-direction: column; 
            align-items: center; /* Pusatkan konten utama */
            width: 100%;
            min-height: calc(100vh - 100px); /* Tinggi viewport dikurangi padding atas & bawah body */
        }

        .auth-container, .dashboard-container, .history-container, .modal-content {
            background-color: #2c2c2c; /* Latar belakang kontainer lebih terang dari body */
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); /* Bayangan lebih gelap */
            width: 100%;
            border: 1px solid #444; /* Border subtil */
        }
        .auth-container { max-width: 450px; margin-top: 20px; margin-bottom: 20px; }
        .dashboard-container, .history-container { max-width: 900px; margin: 20px auto; }


        h1, h2, h3 { color: #ffffff; margin-bottom: 20px; } 
        h1 { font-size: 28px; font-weight: 800; text-align: center; }
        h2 { font-size: 24px; font-weight: 700; }
        .target-card h3 { font-size: 18px; font-weight: 700; text-align: left; color: #f5f5f5; }

        /* Form Styling Tema Gelap */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #b0b0b0; }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group textarea {
            width: 100%; padding: 12px 15px;
            background-color: #3a3a3a; color: #e0e0e0;
            border: 1px solid #555; border-radius: 8px; font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            font-family: 'Nunito Sans', sans-serif; 
        }
        .form-group input::placeholder, .form-group textarea::placeholder { color: #888; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #00acc1; box-shadow: 0 0 0 2px rgba(0, 172, 193, 0.3); }
        .form-text { text-align: center; margin-top: 20px; font-size: 14px; color: #a0a0a0; }
        .form-text a { color: #00bcd4; text-decoration: none; font-weight: 600; }
        .form-text a:hover { text-decoration: underline; }

        /* Tombol Tema Gelap */
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 24px; font-size: 16px; font-weight: 700; line-height: 1.5; text-align: center; text-decoration: none; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; white-space: nowrap; }
        .btn-full-width { width: 100%; }
        .btn-sm { padding: 8px 16px; font-size: 14px; width: auto; }
        .btn i { margin-right: 8px; }
        .btn-primary { background-color: #00bcd4; color: #111; box-shadow: 0px 4px 12px rgba(0, 188, 212, 0.3); }
        .btn-primary:hover { background-color: #00acc1; transform: translateY(-1px); }
        .btn-primary:active { background-color: #0097a7; transform: translateY(0); }
        .btn-secondary { background-color: transparent; color: #00bcd4; border: 2px solid #00bcd4; }
        .btn-secondary:hover { background-color: rgba(0, 188, 212, 0.1); color: #00acc1; border-color: #00acc1; }
        .btn-success { background-color: #4CAF50; color: white; } .btn-success:hover { background-color: #45a049; }
        .btn-danger { background-color: #f44336; color: white; } .btn-danger:hover { background-color: #e53935; }
        .btn-warning { background-color: #ffc107; color: #212529; } .btn-warning:hover { background-color: #e0a800; }
        .btn:disabled, .btn[disabled] { background-color: #424242 !important; color: #757575 !important; border-color: #424242 !important; box-shadow: none !important; cursor: not-allowed !important; transform: none !important; }
        .btn-secondary:disabled, .btn-secondary[disabled] { background-color: transparent !important; color: #757575 !important; border-color: #757575 !important; }

        /* Dashboard & History */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .page-header h2 { text-align: left; margin-bottom: 5px; color: #f5f5f5;}
        #dashboardUserGreeting { font-size: 16px; font-weight: normal; color: #b0b0b0; width: 100%; margin-bottom: 15px; }
        .target-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .target-card { background-color: #3a3a3a; padding: 20px; border-radius: 10px; border: 1px solid #555; box-shadow: 0 4px 8px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .target-info { font-size: 14px; color: #b0b0b0; margin-bottom: 8px; } .target-info strong { color: #e0e0e0; }
        .progress-bar-container { width: 100%; background-color: #555; border-radius: 25px; height: 12px; margin-top: 10px; margin-bottom: 5px; overflow: hidden; }
        .progress-bar { background-color: #00bcd4; height: 100%; border-radius: 25px; width: 0%; transition: width 0.5s ease-in-out; }
        .progress-text { font-size: 12px; color: #a0a0a0; text-align: right; margin-bottom: 15px; }
        
        .target-actions {
            margin-top: auto; 
            padding-top: 15px; 
            display: flex;
            flex-wrap: wrap; 
            gap: 10px; 
        }

        /* Riwayat Transaksi */
        .transaction-table-container { overflow-x: auto; }
        .transaction-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .transaction-table th, .transaction-table td { padding: 10px 12px; border: 1px solid #444; text-align: left; font-size: 14px; white-space: nowrap; }
        .transaction-table th { background-color: #3a3a3a; color: #00bcd4; font-weight: 700; }
        .transaction-table tr:nth-child(even) { background-color: #333333; }
        .transaction-table .amount-deposit { color: #81c784; font-weight: bold; }
        .transaction-table .amount-withdrawal { color: #e57373; font-weight: bold; }
        .transaction-table td:nth-child(5) { white-space: normal; min-width: 200px; } 
        .pagination-controls { margin-top: 20px; text-align: center; display: flex; justify-content: center; align-items: center; gap: 10px;}
        #loadingHistoryText, #noHistoryText { text-align: center; margin-top: 20px; color: #aaa;}

        /* Modal & Animasi */
        .modal { display: flex; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; padding: 20px; opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in-out, visibility 0s linear 0.3s; }
        .modal.open { opacity: 1; visibility: visible; transition-delay: 0s; }
        .modal-content { position: relative; transform: translateY(-30px) scale(0.95); opacity: 0; transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .modal.open .modal-content { transform: translateY(0) scale(1); opacity: 1; }
        .modal-content h2 { text-align: center; color: #f5f5f5; }
        .close-button { color: #777; float: right; font-size: 28px; font-weight: bold; position: absolute; top: 15px; right: 20px; }
        .close-button:hover, .close-button:focus { color: #ccc; text-decoration: none; cursor: pointer; }

        /* QRIS Modal */
        #staticQrisImage { max-width: 250px; max-height: 250px; margin: 15px auto; display: block; border: 1px solid #555; padding: 5px; background-color: white; }
        #qrisPaymentModal p { color: #b0b0b0; } #qrisPaymentModal strong { color: #e0e0e0; }

        /* Custom Alert Modal Styling */
        #customAlertModal .modal-content { max-width: 400px; padding: 25px; }
        #customAlertModal h3 { margin-top: 0; font-size: 20px; display: flex; align-items: center; }
        #customAlertIcon { margin-right: 10px; font-size: 24px; }
        #customAlertModal .modal-content.alert-modal-success #customAlertTitle { color: #4CAF50; }
        #customAlertModal .modal-content.alert-modal-error #customAlertTitle { color: #f44336; }
        #customAlertModal .modal-content.alert-modal-info #customAlertTitle { color: #00bcd4; }
        #customAlertMessage { margin-top: 15px; margin-bottom: 25px; font-size: 16px; color: #c0c0c0; text-align: center; }
        #customAlertOkButton { width: auto; padding: 10px 30px; display: block; margin: 0 auto; }

        /* Navigasi */
        .simple-nav { position: fixed; top: 0; left: 0; width: 100%; background: #2c2c2c; padding: 10px 20px; border-bottom: 1px solid #444; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 1001; display: flex; justify-content: flex-end; align-items: center; gap: 10px; }
        .simple-nav button { background: #4a4a4a; color: #e0e0e0; border: 1px solid #555; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: background-color 0.2s ease; }
        .simple-nav button:hover { background: #5a5a5a; }
        .simple-nav .nav-app-title { margin-right: auto; font-size: 18px; font-weight: 700; color: #00bcd4; }

        .page-section { display: none; }
        .page-section.active { display: block; animation: fadeInPage 0.5s ease-in-out; }
        @keyframes fadeInPage { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="simple-nav">
        <span class="nav-app-title">CelenganKu</span>
        <button id="navDashboardButton" style="display: none;">Dashboard</button>
        <button id="navHistoryButton" style="display: none;">Riwayat Transaksi</button>
        <button id="navToRegisterButton" style="display: none;">Register</button>
        <button id="navToLoginButton" style="display: none;">Login</button>
        <button id="navLogoutButton" style="display: none;">Logout</button>
    </div>

<div class="page-container">
    <section id="loginPinPage" class="page-section">
        <div class="auth-container">
            <h1>Login dengan PIN</h1>
            <form id="loginPinForm">
                <div class="form-group"> <label for="loginEmail">Email</label> <input type="email" id="loginEmail" name="email" required autocomplete="email"> </div>
                <div class="form-group"> <label for="loginPin">Kode PIN (6 digit angka)</label> <input type="password" id="loginPin" name="pin" required maxlength="6" pattern="\d{6}" inputmode="numeric" autocomplete="one-time-code"> </div>
                <button type="submit" class="btn btn-primary btn-full-width"> <i class="fas fa-sign-in-alt"></i> Masuk </button>
                <p class="form-text">Belum punya akun? <a href="#" id="linkToRegisterPage">Daftar di sini</a></p>
            </form>
        </div>
    </section>

    <section id="registerPinPage" class="page-section">
        <div class="auth-container">
            <h1>Registrasi Akun Baru</h1>
            <form id="registerPinForm">
                <div class="form-group"> <label for="registerNama">Nama Lengkap</label> <input type="text" id="registerNama" name="nama" required> </div>
                <div class="form-group"> <label for="registerEmail">Email</label> <input type="email" id="registerEmail" name="email" required> </div>
                <div class="form-group"> <label for="registerPin">Buat Kode PIN (6 digit angka)</label> <input type="password" id="registerPin" name="pin" required maxlength="6" pattern="\d{6}" inputmode="numeric"> </div>
                <button type="submit" class="btn btn-primary btn-full-width"> <i class="fas fa-user-plus"></i> Daftar </button>
                <p class="form-text">Sudah punya akun? <a href="#" id="linkToLoginPage">Login di sini</a></p>
            </form>
        </div>
    </section>

    <section id="dashboardPage" class="page-section">
        <div class="dashboard-container">
            <div class="page-header">
                <h2>Target Tabungan Saya</h2>
                <button id="btnOpenCreateTargetModal" class="btn btn-primary btn-sm"> <i class="fas fa-plus"></i> Buat Target Baru </button>
            </div>
            <span id="dashboardUserGreeting">Memuat data...</span>
            <div class="target-list" id="targetListContainer"> <p style="color: #aaa;">Data target akan muncul di sini.</p> </div>
            <p id="noTargetsText" style="text-align:center; margin-top:20px; display:none;">Anda belum memiliki target tabungan.</p>
        </div>
    </section>

    <section id="historyPage" class="page-section">
        <div class="history-container">
            <div class="page-header"> <h2>Riwayat Transaksi</h2> </div>
            <div class="transaction-table-container">
                <table class="transaction-table">
                    <thead>
                        <tr> <th>Tanggal</th> <th>Target</th> <th>Jenis</th> <th>Jumlah</th> <th>Deskripsi/Alasan</th> </tr>
                    </thead>
                    <tbody id="transactionTableBody"></tbody>
                </table>
            </div>
            <p id="loadingHistoryText" style="display:none;">Memuat riwayat...</p>
            <p id="noHistoryText" style="display:none;">Belum ada riwayat transaksi.</p>
            <div class="pagination-controls" id="historyPagination">
                <button id="prevPageButton" class="btn btn-secondary btn-sm" disabled>&laquo; Sebelumnya</button>
                <span id="currentPageInfo">Halaman 1 dari 1</span>
                <button id="nextPageButton" class="btn btn-secondary btn-sm" disabled>Berikutnya &raquo;</button>
            </div>
        </div>
    </section>

    <div id="createTargetModal" class="modal">
        <div class="modal-content"> <span class="close-button">&times;</span> <h2 id="modalTitle">Buat Target Tabungan Baru</h2> <form id="targetForm"> <input type="hidden" id="targetId" name="targetId"> <div class="form-group"> <label for="namaTarget">Nama Target</label> <input type="text" id="namaTarget" name="nama_target" required> </div> <div class="form-group"> <label for="jumlahTarget">Jumlah Target (Rp)</label> <input type="number" id="jumlahTarget" name="jumlah_target" step="1000" min="0" required> </div> <div class="form-group"> <label for="tanggalTarget">Tanggal Target (Opsional)</label> <input type="date" id="tanggalTarget" name="tanggal_target"> </div> <button type="submit" class="btn btn-primary btn-full-width"> <i class="fas fa-save"></i> Simpan Target </button> </form> </div>
    </div>

    <div id="qrisAmountModal" class="modal">
        <div class="modal-content"> <span class="close-button">&times;</span> <h2>Deposit via QRIS ke "<span id="qrisAmountTargetName">Nama Target</span>"</h2> <form id="qrisAmountForm"> <input type="hidden" id="qrisAmountTargetId"> <div class="form-group"> <label for="qrisJumlahDeposit">Jumlah yang Akan Anda Bayarkan (Rp)</label> <input type="number" id="qrisJumlahDeposit" name="jumlah" step="1000" min="10000" required placeholder="Min. Rp 10.000"> </div> <button type="submit" class="btn btn-success btn-full-width"> <i class="fas fa-qrcode"></i> Tampilkan QRIS </button> </form> </div>
    </div>

    <div id="qrisPaymentModal" class="modal">
        <div class="modal-content"> <span class="close-button">&times;</span> <h2>Scan QRIS Ini Untuk Pembayaran</h2> <p style="text-align: center;">Target: <strong id="qrisPaymentTargetNameDisplay"></strong></p> <p style="text-align: center;">Anda akan membayar sejumlah: <strong id="qrisPaymentAmountDisplay">Rp 0</strong></p> <img id="staticQrisImage" src="" alt="QRIS Pembayaran Statis"> <p style="text-align:center; margin-top:10px; font-size:14px;">Pastikan Anda mentransfer sesuai jumlah di atas.</p> <button id="btnConfirmQrisPaid" class="btn btn-primary btn-full-width" style="margin-top:20px;"> <i class="fas fa-check-circle"></i> Saya Sudah Bayar </button> <input type="hidden" id="qrisConfirmTargetId"> <input type="hidden" id="qrisConfirmAmount"> </div>
    </div>

    <div id="withdrawalModal" class="modal">
        <div class="modal-content"> <span class="close-button">&times;</span> <h2>Tarik Dana dari "<span id="withdrawalTargetName">Nama Target</span>"</h2> <p style="font-size: 14px; margin-bottom: 10px;">Saldo Tersedia: <strong id="withdrawalTargetBalance">Rp 0</strong></p> <form id="withdrawalForm"> <input type="hidden" id="withdrawalTargetId"> <div class="form-group"> <label for="withdrawalAmount">Jumlah Penarikan (Rp)</label> <input type="number" id="withdrawalAmount" name="amount" step="1000" min="1000" required placeholder="Min. Rp 1.000"> </div> <div class="form-group"> <label for="withdrawalReason">Alasan Penarikan (Wajib)</label> <textarea id="withdrawalReason" name="reason" rows="3" required placeholder="Contoh: Keperluan mendadak, beli barang X"></textarea> </div> <button type="submit" class="btn btn-danger btn-full-width"> <i class="fas fa-arrow-circle-down"></i> Konfirmasi Penarikan </button> </form> </div>
    </div>
    
    <div id="customAlertModal" class="modal">
        <div class="modal-content">
            <h3 id="customAlertTitle"><i id="customAlertIcon" class="fas"></i> <span style="margin-left: 8px;">Judul Alert</span></h3>
            <p id="customAlertMessage">Isi pesan alert di sini.</p>
            <button id="customAlertOkButton" class="btn btn-primary">OK</button>
        </div>
    </div>

</div>    <script>
        // --- Global Variables & Configuration ---
        const API_BASE_URL = 'https://celengan.up.railway.app/api'; // GANTI DENGAN URL BACKEND ANDA YANG SUDAH DI-DEPLOY!
        let currentAuthToken = localStorage.getItem('celenganAuthToken');
        let currentUser = JSON.parse(localStorage.getItem('celenganCurrentUser'));
        let STATIC_QRIS_IMAGE_URL = "";
        let currentTransactionPage = 1;
        const transactionsPerPage = 10;

        // --- Utility Functions ---
        async function apiCall(endpoint, method = 'GET', body = null, requiresAuth = true) {
            const headers = { 'Content-Type': 'application/json' };
            if (requiresAuth && currentAuthToken) {
                headers['Authorization'] = `Bearer ${currentAuthToken}`;
            } else if (requiresAuth && !currentAuthToken) {
                showMessage('Sesi tidak valid atau Anda belum login. Silakan login kembali.', 'error');
                handleLogout(false); return null;
            }
            const config = { method: method, headers: headers };
            if (body) { config.body = JSON.stringify(body); }
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                let responseTextForError = ''; 
                if ((response.status === 401 || response.status === 403) && requiresAuth) {
                    let errorData = { message: `Akses ditolak (${response.status}). Sesi mungkin berakhir atau tidak valid.` };
                    try { errorData = await response.json(); } catch (e) { /* biarkan errorData default */ }
                    showMessage(errorData.message, 'error');
                    if(response.status === 401) handleLogout(false);
                    return null;
                }
                let data;
                try {
                    // Clone respons untuk bisa baca teks jika json() gagal
                    const clonedResponse = response.clone(); // Harus dilakukan sebelum response dipakai
                    data = await response.json();
                } catch (e) {
                    console.error('Error parsing JSON response:', e);
                    // Coba baca teks dari respons asli jika clone gagal atau response.text() tidak tersedia di clone
                    // (beberapa implementasi fetch mungkin hanya mengizinkan body dibaca sekali)
                    try {
                        responseTextForError = await (response.text ? response.text() : clonedResponse.text());
                    } catch (textError) {
                        responseTextForError = "Tidak bisa membaca isi respons.";
                    }
                    console.error('Response text:', responseTextForError);
                    showMessage(`Server memberikan respons yang tidak valid (bukan JSON). Status: ${response.status}. Cek console untuk detail.`, 'error');
                    return null;
                }
                if (!response.ok) {
                    console.error('API Error Response:', data);
                    showMessage(data.message || `Error ${response.status}: Terjadi kesalahan`, 'error');
                    return null;
                }
                return data;
            } catch (error) {
                console.error('Network or other error (Failed to fetch):', error);
                showMessage('Tidak dapat terhubung ke server. Periksa koneksi internet Anda atau konfigurasi API URL.', 'error');
                return null;
            }
        }
        
        function showMessage(message, type = 'info', autoCloseDelay = 0) {
            const alertModal = document.getElementById('customAlertModal');
            const alertTitleSpan = alertModal.querySelector('#customAlertTitle span');
            const alertIconEl = document.getElementById('customAlertIcon');
            const alertMessageEl = document.getElementById('customAlertMessage');
            const modalContent = alertModal.querySelector('.modal-content');
            const okButton = document.getElementById('customAlertOkButton');
            
            modalContent.classList.remove('alert-modal-success', 'alert-modal-error', 'alert-modal-info');

            if (type === 'success') {
                alertTitleSpan.textContent = 'Sukses!';
                if(alertIconEl) alertIconEl.className = 'fas fa-check-circle';
                modalContent.classList.add('alert-modal-success');
            } else if (type === 'error') {
                alertTitleSpan.textContent = 'Error!';
                if(alertIconEl) alertIconEl.className = 'fas fa-exclamation-triangle';
                modalContent.classList.add('alert-modal-error');
            } else { 
                alertTitleSpan.textContent = 'Informasi';
                if(alertIconEl) alertIconEl.className = 'fas fa-info-circle';
                modalContent.classList.add('alert-modal-info');
            }
            alertMessageEl.textContent = message;
            console.log(`CustomAlert [${type.toUpperCase()}]: ${message}`); // Tetap log ke console
            openModal('customAlertModal');

            if (autoCloseDelay > 0) {
                if(okButton) okButton.style.display = 'none'; // Sembunyikan tombol OK jika auto close
                setTimeout(() => {
                    // Pastikan modal masih terbuka sebelum menutup (mungkin sudah ditutup manual)
                    if (document.getElementById('customAlertModal').classList.contains('open')) {
                        closeModal('customAlertModal');
                    }
                    if(okButton) okButton.style.display = 'block'; // Kembalikan tombol OK
                }, autoCloseDelay);
            } else {
                 if(okButton) okButton.style.display = 'block'; // Tampilkan tombol OK jika tidak auto close
            }
        }

        // --- Config Fetcher ---
        async function fetchAppConfig() {
            const configData = await apiCall('/transactions/config', 'GET', null, false);
            if (configData && configData.staticQrisImageUrl) {
                STATIC_QRIS_IMAGE_URL = configData.staticQrisImageUrl;
                console.log("Static QRIS Image URL loaded:", STATIC_QRIS_IMAGE_URL);
            } else {
                console.error("Gagal mengambil URL QRIS statis dari server atau URL tidak valid. Pesan dari server:", configData ? configData.warning || "Tidak ada URL." : "Tidak ada respons config.");
                // showMessage("Konfigurasi pembayaran QRIS tidak lengkap. Fitur QRIS mungkin tidak berfungsi.", "warning"); 
            }
        }

        // --- Authentication Functions ---
        async function handlePinLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pin = document.getElementById('loginPin').value;
            if (!email || !pin) { showMessage('Email dan PIN harus diisi.', 'error'); return; }
            if (!/^\d{6}$/.test(pin)) { showMessage('PIN tidak valid. Harus 6 digit angka.', 'error'); return; }
            const data = await apiCall('/auth/login-pin', 'POST', { email, pin }, false);
            if (data && data.token) {
                currentAuthToken = data.token;
                currentUser = { id: data.id, nama: data.nama, email: data.email };
                localStorage.setItem('celenganAuthToken', currentAuthToken);
                localStorage.setItem('celenganCurrentUser', JSON.stringify(currentUser));
                showMessage(`Login berhasil! Selamat datang, ${data.nama}.`, 'success', 2000);
                document.getElementById('dashboardUserGreeting').textContent = `Halo, ${currentUser.nama}!`;
                showPage('dashboardPage');
                // loadTargets(); // Akan dipanggil oleh showPage('dashboardPage')
            }
            document.getElementById('loginPinForm').reset();
        }
        async function handlePinRegister(event) {
            event.preventDefault();
            const nama = document.getElementById('registerNama').value;
            const email = document.getElementById('registerEmail').value;
            const pin = document.getElementById('registerPin').value;
            if (!nama || !email || !pin) { showMessage('Nama, Email, dan PIN harus diisi.', 'error'); return; }
            if (!/^\d{6}$/.test(pin)) { showMessage('PIN tidak valid. Harus 6 digit angka.', 'error'); return; }
            const data = await apiCall('/auth/register-pin', 'POST', { nama, email, pin }, false);
            if (data && data.token) {
                currentAuthToken = data.token;
                currentUser = { id: data.id, nama: data.nama, email: data.email };
                localStorage.setItem('celenganAuthToken', currentAuthToken);
                localStorage.setItem('celenganCurrentUser', JSON.stringify(currentUser));
                showMessage('Registrasi berhasil! Selamat datang.', 'success', 2000);
                document.getElementById('dashboardUserGreeting').textContent = `Halo, ${currentUser.nama}!`;
                showPage('dashboardPage');
                // loadTargets(); // Akan dipanggil oleh showPage('dashboardPage')
            } else if (data && data.id && !data.token) {
                showMessage('Registrasi berhasil! Silakan login dengan PIN Anda.', 'success');
                showPage('loginPinPage');
            }
            document.getElementById('registerPinForm').reset();
        }
        function handleLogout(showMsg = true) {
            localStorage.removeItem('celenganAuthToken');
            localStorage.removeItem('celenganCurrentUser');
            currentAuthToken = null;
            currentUser = null;
            if (showMsg) showMessage('Anda telah berhasil logout.', 'info', 2000);
            showPage('loginPinPage');
        }
        async function checkAuthStatus() {
            await fetchAppConfig();
            const token = localStorage.getItem('celenganAuthToken');
            const user = JSON.parse(localStorage.getItem('celenganCurrentUser'));
            if (token && user) {
                currentAuthToken = token;
                currentUser = user;
                const userProfile = await apiCall('/auth/profile', 'GET');
                if (userProfile && userProfile.id) {
                    currentUser = userProfile;
                    localStorage.setItem('celenganCurrentUser', JSON.stringify(currentUser));
                    if(document.getElementById('dashboardUserGreeting')) document.getElementById('dashboardUserGreeting').textContent = `Halo, ${currentUser.nama}!`;
                    showPage('dashboardPage'); // Default ke dashboard jika sudah login
                } else { handleLogout(false); } // Token ada tapi tidak valid lagi di backend
            } else { showPage('loginPinPage'); } // Default ke login jika tidak ada token
        }

        // --- Target Management Functions ---
        async function loadTargets() {
            const targetListContainer = document.getElementById('targetListContainer');
            const noTargetsText = document.getElementById('noTargetsText');
            if (!currentUser) { if(targetListContainer) targetListContainer.innerHTML = '<p style="color: #aaa;">Silakan login untuk melihat target.</p>'; if(noTargetsText) noTargetsText.style.display = 'none'; return; }
            if(targetListContainer) targetListContainer.innerHTML = '<p style="color: #aaa;">Memuat target...</p>';
            
            const response = await apiCall('/targets', 'GET'); // Backend /api/targets mengembalikan array langsung
            console.log("[loadTargets] Response from API:", response); 

            if (response && Array.isArray(response)) {
                if(targetListContainer) targetListContainer.innerHTML = '';
                if (response.length === 0) {
                    if(noTargetsText) { noTargetsText.textContent = 'Anda belum memiliki target tabungan.'; noTargetsText.style.display = 'block'; }
                } else {
                    if(noTargetsText) noTargetsText.style.display = 'none';
                    response.forEach(target => targetListContainer.appendChild(renderTargetCard(target)));
                }
            } else if (currentAuthToken) { 
                if(targetListContainer) targetListContainer.innerHTML = '<p style="color: #aaa;">Gagal memuat target atau format data dari server salah.</p>';
                if(noTargetsText) noTargetsText.style.display = 'none';
                console.error("[loadTargets] Gagal memuat target, respons tidak valid:", response);
            }
        }
        function renderTargetCard(target) {
            const card = document.createElement('div'); card.className = 'target-card'; card.setAttribute('data-target-id', target.id);
            const progress = target.jumlah_target > 0 ? Math.min((target.jumlah_terkumpul / target.jumlah_target) * 100, 100) : 0;
            const terkumpulFormatted = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(target.jumlah_terkumpul);
            const targetFormatted = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(target.jumlah_target);
            const tanggalTargetFormatted = target.tanggal_target ? new Date(target.tanggal_target).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Tidak ada';
            let qrisButtonHtml = '';
            if (target.status === 'aktif' && STATIC_QRIS_IMAGE_URL && STATIC_QRIS_IMAGE_URL !== "URL_GAMBAR_QRIS_STATIS_ANDA_DISINI" && STATIC_QRIS_IMAGE_URL.trim() !== "" && STATIC_QRIS_IMAGE_URL.startsWith('http')) {
                qrisButtonHtml = `<button class="btn btn-success btn-sm btn-qris-deposit"><i class="fas fa-qrcode"></i> Bayar QRIS</button>`;
            }
            const withdrawButtonHtml = parseFloat(target.jumlah_terkumpul) > 0 ? `<button class="btn btn-warning btn-sm btn-withdraw"><i class="fas fa-hand-holding-usd"></i> Tarik Dana</button>` : '';
            card.innerHTML = `<h3>${target.nama_target}</h3> <div class="target-info">Target: <strong>${targetFormatted}</strong></div> <div class="target-info">Terkumpul: <strong>${terkumpulFormatted}</strong></div> <div class="target-info">Tanggal Target: <strong>${tanggalTargetFormatted}</strong></div> <div class="target-info">Status: <strong style="text-transform:capitalize;">${target.status}</strong></div> <div class="progress-bar-container"><div class="progress-bar" style="width: ${progress.toFixed(2)}%;"></div></div> <div class="progress-text">${progress.toFixed(1)}%</div> <div class="target-actions"> ${qrisButtonHtml} ${withdrawButtonHtml} <button class="btn btn-secondary btn-sm btn-edit"><i class="fas fa-edit"></i> Edit</button> <button class="btn btn-danger btn-sm btn-delete"><i class="fas fa-trash"></i> Hapus</button> </div>`;
            const qrisDepositButton = card.querySelector('.btn-qris-deposit'); if (qrisDepositButton) { qrisDepositButton.addEventListener('click', () => openQrisAmountModal(target.id, target.nama_target)); }
            const withdrawButton = card.querySelector('.btn-withdraw'); if (withdrawButton) { withdrawButton.addEventListener('click', () => openWithdrawalModal(target.id, target.nama_target, target.jumlah_terkumpul)); }
            card.querySelector('.btn-edit').addEventListener('click', () => openEditTargetModal(target.id));
            card.querySelector('.btn-delete').addEventListener('click', () => handleDeleteTarget(target.id, target.nama_target));
            return card;
        }
        async function handleTargetForm(event) {
            event.preventDefault(); if (!currentUser) { showMessage("Anda harus login.", "error"); return; }
            const targetId = document.getElementById('targetId').value;
            const nama_target = document.getElementById('namaTarget').value;
            const jumlah_target = document.getElementById('jumlahTarget').value;
            const tanggal_target = document.getElementById('tanggalTarget').value || null;
            if (!nama_target || !jumlah_target || parseFloat(jumlah_target) <= 0) { showMessage('Nama target dan jumlah target (positif) harus diisi.', 'error'); return; }
            const payload = { nama_target, jumlah_target: parseFloat(jumlah_target), tanggal_target };
            let result;
            console.log(targetId ? `Mode Edit, ID: ${targetId}` : "Mode Buat Baru");
            if (targetId) { result = await apiCall(`/targets/${targetId}`, 'PUT', payload); }
            else { result = await apiCall('/targets', 'POST', payload); }
            if (result && (result.id || result.nama_target || (result.message && result.message.toLowerCase().includes('berhasil')) || (result.message && result.message.toLowerCase().includes('updated')))) {
                showMessage(targetId ? 'Target berhasil diperbarui!' : 'Target baru berhasil dibuat!', 'success');
                closeModal('createTargetModal'); loadTargets();
            }
        }
        async function openEditTargetModal(targetIdToEdit) {
            if (!currentUser) { showMessage("Anda harus login.", "error"); return; }
            const target = await apiCall(`/targets/${targetIdToEdit}`, 'GET');
            if (target && target.id) {
                document.getElementById('targetForm').reset();
                document.getElementById('modalTitle').textContent = 'Edit Target Tabungan';
                document.getElementById('targetId').value = target.id;
                document.getElementById('namaTarget').value = target.nama_target;
                document.getElementById('jumlahTarget').value = target.jumlah_target;
                document.getElementById('tanggalTarget').value = target.tanggal_target ? target.tanggal_target.split('T')[0] : '';
                openModal('createTargetModal');
            }
        }
        async function handleDeleteTarget(targetId, targetName) {
            const confirmDelete = await new Promise(resolve => {
                const alertModal = document.getElementById('customAlertModal');
                const alertTitleSpan = alertModal.querySelector('#customAlertTitle span');
                const alertIconEl = document.getElementById('customAlertIcon');
                const alertMessageEl = document.getElementById('customAlertMessage');
                const modalContent = alertModal.querySelector('.modal-content');
                const okButton = document.getElementById('customAlertOkButton');
                modalContent.classList.remove('alert-modal-success', 'alert-modal-error');
                modalContent.classList.add('alert-modal-info');
                alertTitleSpan.textContent = 'Konfirmasi Hapus';
                if(alertIconEl) alertIconEl.className = 'fas fa-question-circle';
                alertMessageEl.textContent = `Apakah Anda yakin ingin menghapus target "${targetName}"? Aksi ini tidak dapat dibatalkan.`;
                const originalOkHTML = okButton.innerHTML;
                const originalOkClasses = okButton.className;
                okButton.innerHTML = '<i class="fas fa-trash"></i> Ya, Hapus';
                okButton.className = 'btn btn-danger';
                let tempButtonContainer = okButton.parentNode.querySelector('.temp-button-container');
                if (!tempButtonContainer) {
                    tempButtonContainer = document.createElement('div');
                    tempButtonContainer.className = 'temp-button-container';
                    tempButtonContainer.style.display = 'flex';
                    tempButtonContainer.style.justifyContent = 'center';
                    tempButtonContainer.style.gap = '10px';
                    tempButtonContainer.style.marginTop = '20px';
                    okButton.parentNode.appendChild(tempButtonContainer);
                } else {
                    tempButtonContainer.innerHTML = ''; // Bersihkan container jika sudah ada
                }
                tempButtonContainer.appendChild(okButton);
                const cancelButton = document.createElement('button');
                cancelButton.innerHTML = '<i class="fas fa-times"></i> Batal';
                cancelButton.className = 'btn btn-secondary';
                tempButtonContainer.appendChild(cancelButton);
                const onOk = () => { cleanup(); resolve(true); };
                const onCancel = () => { cleanup(); resolve(false); };
                const cleanup = () => {
                    okButton.removeEventListener('click', onOk);
                    cancelButton.removeEventListener('click', onCancel);
                    okButton.innerHTML = originalOkHTML;
                    okButton.className = originalOkClasses;
                    // Pindahkan OK button kembali ke parent aslinya jika perlu (jika struktur berubah)
                    if (modalContent.contains(tempButtonContainer)) {
                         modalContent.appendChild(okButton); // Kembalikan OK ke parent semula
                    }
                    tempButtonContainer.remove();
                    closeModal('customAlertModal');
                };
                okButton.addEventListener('click', onOk, { once: true });
                cancelButton.addEventListener('click', onCancel, { once: true });
                openModal('customAlertModal');
            });
            if (confirmDelete) {
                if (!currentUser) { showMessage("Anda harus login.", "error"); return; }
                const result = await apiCall(`/targets/${targetId}`, 'DELETE');
                if (result && result.message === 'Target removed') { showMessage('Target berhasil dihapus.', 'success'); loadTargets(); }
            }
        }

        // --- QRIS Payment Functions (Simplified Flow) ---
        function openQrisAmountModal(targetId, targetName) { /* ... kode sama dari #84 ... */ }
        async function handleQrisAmountForm(event) { /* ... kode sama dari #84 ... */ }
        async function handleQrisUserConfirmation() { /* ... kode sama dari #84 ... */ }
        
        // --- Withdrawal Functions ---
        function openWithdrawalModal(targetId, targetName, currentBalance) { /* ... kode sama dari #84 ... */ }
        async function handleWithdrawalForm(event) { /* ... kode sama dari #84 ... */ }

        // --- Transaction History Functions (Dengan logging tambahan) ---
        async function loadTransactionHistory(page = 1) {
            const tableBody = document.getElementById('transactionTableBody');
            const loadingText = document.getElementById('loadingHistoryText');
            const noHistoryText = document.getElementById('noHistoryText');
            const paginationControls = document.getElementById('historyPagination');

            console.log(`[loadTransactionHistory] Meminta riwayat untuk halaman: ${page}`);

            if (!currentUser) {
                if (tableBody) tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: #aaa;">Silakan login untuk melihat riwayat.</td></tr>';
                if (loadingText) loadingText.style.display = 'none';
                if (noHistoryText) { noHistoryText.textContent = 'Silakan login untuk melihat riwayat.'; noHistoryText.style.display = 'block'; }
                if (paginationControls) paginationControls.style.display = 'none';
                return;
            }

            currentTransactionPage = page;
            if(loadingText) loadingText.style.display = 'block';
            if(noHistoryText) noHistoryText.style.display = 'none';
            if(tableBody) tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: #aaa;">Memuat riwayat transaksi halaman ${page}...</td></tr>`;
            if(paginationControls) paginationControls.style.display = 'none';

            const response = await apiCall(`/transactions?page=${page}&limit=${transactionsPerPage}`, 'GET');
            console.log("[loadTransactionHistory] Respons MENTAH dari backend /api/transactions:", JSON.stringify(response, null, 2));

            if(loadingText) loadingText.style.display = 'none';

            if (response && response.data && Array.isArray(response.data) && response.pagination) {
                console.log(`[loadTransactionHistory] Menerima ${response.data.length} transaksi, pagination:`, response.pagination);
                if (response.data.length === 0) {
                    if (page === 1) {
                        if(noHistoryText) { noHistoryText.textContent = 'Belum ada riwayat transaksi.'; noHistoryText.style.display = 'block'; }
                        if(tableBody) tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: #aaa;">Belum ada riwayat transaksi.</td></tr>';
                    } else {
                        if(tableBody) tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: #aaa;">Tidak ada transaksi lagi di halaman ini.</td></tr>';
                        if(paginationControls) paginationControls.style.display = 'flex';
                    }
                } else {
                    if(noHistoryText) noHistoryText.style.display = 'none';
                    renderTransactionHistory(response.data, response.pagination);
                     if(paginationControls && response.pagination.total_pages > 0) {
                        paginationControls.style.display = 'flex';
                    }
                }
            } else {
                console.error("[loadTransactionHistory] Gagal memuat atau format data riwayat transaksi salah. Respons diterima:", response);
                if(tableBody) tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: #aaa;">Gagal memuat riwayat transaksi. Coba lagi nanti atau periksa console.</td></tr>';
                if(noHistoryText) { noHistoryText.textContent = 'Gagal memuat riwayat transaksi.'; noHistoryText.style.display = 'block'; }
            }
        }

        function renderTransactionHistory(transactions, pagination) {
            const tableBody = document.getElementById('transactionTableBody');
            if (!tableBody) { console.error("Elemen tableBody tidak ditemukan untuk render riwayat!"); return; }
            tableBody.innerHTML = ''; 
            transactions.forEach(trx => {
                const row = tableBody.insertRow();
                const date = new Date(trx.tanggal_transaksi).toLocaleString('id-ID', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                const amountFormatted = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(trx.jumlah);
                row.insertCell().textContent = date;
                row.insertCell().textContent = trx.nama_target || '(Target Dihapus)';
                const typeCell = row.insertCell(); typeCell.textContent = trx.jenis_transaksi;
                const amountCell = row.insertCell();
                amountCell.textContent = (trx.jenis_transaksi === 'WITHDRAWAL' ? '-' : '+') + amountFormatted;
                if (trx.jenis_transaksi === 'DEPOSIT') { amountCell.className = 'amount-deposit'; typeCell.style.color = '#81c784'; }
                else if (trx.jenis_transaksi === 'WITHDRAWAL') { amountCell.className = 'amount-withdrawal'; typeCell.style.color = '#e57373'; }
                row.insertCell().textContent = trx.deskripsi || '-';
            });
            const currentPageInfo = document.getElementById('currentPageInfo');
            const prevPageButton = document.getElementById('prevPageButton');
            const nextPageButton = document.getElementById('nextPageButton');
            if(pagination && currentPageInfo) currentPageInfo.textContent = `Halaman ${pagination.page} dari ${pagination.total_pages || 1}`;
            if(pagination && prevPageButton) prevPageButton.disabled = !pagination.has_prev_page;
            if(pagination && nextPageButton) nextPageButton.disabled = !pagination.has_next_page;
        }

        // --- Modal Control ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                if (modalId === 'createTargetModal' && document.getElementById('targetId') && !document.getElementById('targetId').value) {
                    const targetForm = document.getElementById('targetForm'); if(targetForm) targetForm.reset();
                    const modalTitle = document.getElementById('modalTitle'); if(modalTitle) modalTitle.textContent = 'Buat Target Tabungan Baru';
                }
                modal.style.display = 'flex';
                setTimeout(() => { modal.classList.add('open'); }, 10);
            }
        }
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('open');
                if (modalId !== 'customAlertModal') {
                    const form = modal.querySelector('form');
                    if (form) { form.reset(); }
                }
                if (modalId === 'createTargetModal') {
                    const targetIdInput = document.getElementById('targetId'); if (targetIdInput) targetIdInput.value = '';
                    const modalTitle = document.getElementById('modalTitle'); if(modalTitle) modalTitle.textContent = 'Buat Target Tabungan Baru';
                }
            }
        }

        // --- Page Navigation ---
        function showPage(pageId) {
            document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
            const pageToShow = document.getElementById(pageId);
            if (pageToShow) pageToShow.classList.add('active');
            const navDashboard = document.getElementById('navDashboardButton');
            const navHistory = document.getElementById('navHistoryButton');
            const navLogout = document.getElementById('navLogoutButton');
            const navToRegister = document.getElementById('navToRegisterButton');
            const navToLogin = document.getElementById('navToLoginButton');
            if(navDashboard) navDashboard.style.backgroundColor = '#4a4a4a';
            if(navHistory) navHistory.style.backgroundColor = '#4a4a4a';
            if (currentAuthToken && currentUser) {
                if(navDashboard) navDashboard.style.display = 'inline-block';
                if(navHistory) navHistory.style.display = 'inline-block';
                if(navLogout) navLogout.style.display = 'inline-block';
                if(navToRegister) navToRegister.style.display = 'none';
                if(navToLogin) navToLogin.style.display = 'none';
                const activeModal = document.querySelector('.modal.open');
                if (!activeModal) {
                    if (pageId === 'dashboardPage') { if(navDashboard) navDashboard.style.backgroundColor = '#00bcd4'; loadTargets(); }
                    else if (pageId === 'historyPage') { if(navHistory) navHistory.style.backgroundColor = '#00bcd4'; loadTransactionHistory(1); }
                    else if (pageId !== 'loginPinPage' && pageId !== 'registerPinPage' && document.getElementById('dashboardPage')) {
                        if (pageId !== 'dashboardPage') showPage('dashboardPage');
                    }
                } else if (pageId === 'historyPage' && !activeModal){ loadTransactionHistory(1); }
            } else {
                if(navDashboard) navDashboard.style.display = 'none'; if(navHistory) navHistory.style.display = 'none'; if(navLogout) navLogout.style.display = 'none';
                const activeModal = document.querySelector('.modal.open'); if (activeModal) closeModal(activeModal.id);
                if (pageId === 'loginPinPage') { if(navToRegister) navToRegister.style.display = 'inline-block'; if(navToLogin) navToLogin.style.display = 'none'; }
                else if (pageId === 'registerPinPage') { if(navToRegister) navToRegister.style.display = 'none'; if(navToLogin) navToLogin.style.display = 'inline-block'; }
                else { if(navToRegister) navToRegister.style.display = 'inline-block'; if(navToLogin) navToLogin.style.display = 'none'; if(document.getElementById('loginPinPage')) showPage('loginPinPage');}
            }
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            const loginForm = document.getElementById('loginPinForm'); if(loginForm) loginForm.addEventListener('submit', handlePinLogin);
            const registerForm = document.getElementById('registerPinForm'); if(registerForm) registerForm.addEventListener('submit', handlePinRegister);
            const targetForm = document.getElementById('targetForm'); if(targetForm) targetForm.addEventListener('submit', handleTargetForm);
            const qrisAmountForm = document.getElementById('qrisAmountForm'); if(qrisAmountForm) qrisAmountForm.addEventListener('submit', handleQrisAmountForm);
            const btnConfirmQrisPaid = document.getElementById('btnConfirmQrisPaid'); if(btnConfirmQrisPaid) btnConfirmQrisPaid.addEventListener('click', handleQrisUserConfirmation);
            const withdrawalForm = document.getElementById('withdrawalForm'); if (withdrawalForm) withdrawalForm.addEventListener('submit', handleWithdrawalForm);
            const customAlertOkButton = document.getElementById('customAlertOkButton'); if(customAlertOkButton) customAlertOkButton.addEventListener('click', () => closeModal('customAlertModal'));
            document.querySelectorAll('.modal .close-button').forEach(button => button.addEventListener('click', () => closeModal(button.closest('.modal').id)));
            window.addEventListener('click', (event) => { document.querySelectorAll('.modal').forEach(modal => { if (event.target == modal) closeModal(modal.id); }); });
            const navLogoutButton = document.getElementById('navLogoutButton'); if(navLogoutButton) navLogoutButton.addEventListener('click', () => handleLogout());
            const linkToRegister = document.getElementById('linkToRegisterPage'); if(linkToRegister) linkToRegister.addEventListener('click', (e) => { e.preventDefault(); showPage('registerPinPage'); });
            const linkToLogin = document.getElementById('linkToLoginPage'); if(linkToLogin) linkToLogin.addEventListener('click', (e) => { e.preventDefault(); showPage('loginPinPage'); });
            const navToRegisterButton = document.getElementById('navToRegisterButton'); if(navToRegisterButton) navToRegisterButton.addEventListener('click', () => showPage('registerPinPage'));
            const navToLoginButton = document.getElementById('navToLoginButton'); if(navToLoginButton) navToLoginButton.addEventListener('click', () => showPage('loginPinPage'));
            const navDashboardButton = document.getElementById('navDashboardButton'); if(navDashboardButton) navDashboardButton.addEventListener('click', () => showPage('dashboardPage'));
            const navHistoryButton = document.getElementById('navHistoryButton'); if(navHistoryButton) navHistoryButton.addEventListener('click', () => showPage('historyPage'));
            const prevPageBtn = document.getElementById('prevPageButton'); if(prevPageBtn) prevPageBtn.addEventListener('click', () => { if (currentTransactionPage > 1) loadTransactionHistory(currentTransactionPage - 1); });
            const nextPageBtn = document.getElementById('nextPageButton'); if(nextPageBtn) nextPageBtn.addEventListener('click', () => { loadTransactionHistory(currentTransactionPage + 1); });
            const btnOpenCreateTargetModal = document.getElementById('btnOpenCreateTargetModal');
            if(btnOpenCreateTargetModal) {
                btnOpenCreateTargetModal.addEventListener('click', () => {
                    if (!currentAuthToken || !currentUser) { showMessage("Anda harus login untuk membuat target.", "error"); showPage('loginPinPage'); return; }
                    document.getElementById('targetForm').reset();
                    document.getElementById('targetId').value = '';
                    document.getElementById('modalTitle').textContent = 'Buat Target Tabungan Baru';
                    openModal('createTargetModal');
                });
            }
        }

        // Panggil saat DOM sudah siap
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            checkAuthStatus(); 
        });

    </script>
</body>
</html>
